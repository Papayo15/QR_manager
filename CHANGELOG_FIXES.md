# Changelog - Correcciones de Crashes y Flashazo Blanco

## Fecha: 2025-10-16
## Versi√≥n: 2.1.0

---

## Resumen de Cambios

Este changelog documenta las correcciones implementadas para resolver los problemas de crashes y el flashazo blanco que experimentaban las aplicaciones m√≥viles.

### Problemas Resueltos

‚úÖ **Flashazo blanco al abrir las apps** - Las apps se quedaban en pantalla blanca
‚úÖ **Crashes por errores no manejados** - El backend crasheaba ante cualquier error
‚úÖ **Desconexi√≥n entre apps y API** - Las apps y el backend no pod√≠an comunicarse
‚úÖ **Crashes en builds de release** - ProGuard ofuscaba c√≥digo cr√≠tico
‚úÖ **Configuraci√≥n faltante** - No estaba documentado SPREADSHEET_ID

---

## Cambios Detallados

### 1. Backend - Manejo de Errores Completo

#### Archivo: `backend/src/services/sheetsService.js`

**Antes**: Ning√∫n m√©todo ten√≠a try-catch, cualquier error crasheaba el servidor

**Despu√©s**: Todos los m√©todos tienen manejo de errores completo:

- ‚úÖ `ensureSheetExists()` - Try-catch + logging
- ‚úÖ `registerCode()` - Try-catch + validaci√≥n de datos
- ‚úÖ `registerWorker()` - Try-catch + validaci√≥n de datos
- ‚úÖ `validateCode()` - Try-catch + logging detallado
- ‚úÖ `updateStatus()` - Try-catch + logging
- ‚úÖ `getHistory()` - Try-catch + validaci√≥n
- ‚úÖ `getCounters()` - Try-catch + validaci√≥n

**Beneficio**: El servidor ahora maneja errores gracefully sin crashear

---

### 2. Backend - M√≥dulo de Mapeo de Par√°metros (CR√çTICO)

#### Archivo: `backend/src/utils/paramMapper.js` (NUEVO)

**Problema**: Las apps enviaban `{houseNumber, condominio}` pero el backend esperaba `{sheetId, sheetName, casa}`

**Soluci√≥n**: Nuevo m√≥dulo que mapea autom√°ticamente:

```javascript
// Input de la app
{ houseNumber: 25, condominio: "Unica" }

// Output para el backend
{
  sheetId: process.env.SPREADSHEET_ID,
  sheetName: "Registros_Casa_25",
  casa: "25",
  condominio: "Unica"
}
```

**Funciones incluidas**:
- `mapAppParamsToBackend()` - Mapeo principal
- `getSpreadsheetId()` - Lee SPREADSHEET_ID del .env
- `getSheetName()` - Genera nombre de hoja
- `generateQRCode()` - Genera c√≥digos aleatorios
- `getCurrentDateTime()` - Obtiene fecha/hora formateada

**Beneficio**: Las apps ahora pueden comunicarse con el backend sin cambios

---

### 3. Backend - Endpoints Adaptados

#### Archivo: `backend/src/server.js`

**Cambios**:

1. **POST /api/register-code**
   - Antes: Esperaba `{sheetId, sheetName, codigo, ...}`
   - Despu√©s: Acepta `{houseNumber, condominio}`
   - Genera c√≥digo QR autom√°ticamente
   - Responde con formato esperado por la app

2. **POST /api/validate-qr**
   - Antes: Esperaba `{sheetId, codigo}`
   - Despu√©s: Acepta `{code}`
   - Usa SPREADSHEET_ID global
   - Busca en todas las hojas autom√°ticamente

3. **GET /api/get-history**
   - Antes: Esperaba `?sheetId=X&sheetName=Y&casa=Z`
   - Despu√©s: Acepta `?houseNumber=X&condominio=Y`
   - Mapea autom√°ticamente los par√°metros

4. **GET /api/counters**
   - Antes: Esperaba `?sheetId=X`
   - Despu√©s: No requiere par√°metros
   - Usa SPREADSHEET_ID global

5. **POST /api/register-worker**
   - Antes: Esperaba `{sheetId, sheetName, ...}`
   - Despu√©s: Acepta `{houseNumber, condominio, workerType, photoBase64}`

**Beneficio**: Total compatibilidad con las apps m√≥viles existentes

---

### 4. ProGuard - Configuraci√≥n Completa

#### Archivos:
- `apps/ResidenteApp/android/app/proguard-rules.pro`
- `apps/VigilanciaApp/android/app/proguard-rules.pro`

**Antes**: Archivos vac√≠os - ProGuard ofuscaba TODO

**Despu√©s**: Reglas completas para:
- ‚úÖ React Native core
- ‚úÖ Hermes engine
- ‚úÖ Navegaci√≥n (React Navigation)
- ‚úÖ AsyncStorage
- ‚úÖ SVG y QR Code
- ‚úÖ Image Picker (VigilanciaApp)
- ‚úÖ Vision Camera (VigilanciaApp)
- ‚úÖ React Native Share (ResidenteApp)

**Beneficio**: Los builds de release ahora funcionan sin crashes

---

### 5. Variables de Entorno - Documentaci√≥n

#### Archivo: `backend/.env.example`

**Antes**: Documentaci√≥n m√≠nima

**Despu√©s**: Documentaci√≥n completa con:
- ‚úÖ Descripci√≥n de cada variable
- ‚úÖ Formato exacto requerido
- ‚úÖ Instrucciones para obtener SPREADSHEET_ID
- ‚úÖ Gu√≠a de permisos de Google Cloud
- ‚úÖ Instrucciones de deployment en Render

**Variable cr√≠tica a√±adida**:
```env
SPREADSHEET_ID=1h_fEz5tDjNmdZ-57F2CoL5W6RjjAF7Yhw4ttJgypb7o
```

**Beneficio**: Configuraci√≥n clara y sin errores

---

### 6. Apps M√≥viles - Manejo de Errores Mejorado

#### Archivos:
- `apps/ResidenteApp/src/services/api.ts`
- `apps/VigilanciaApp/src/services/api.ts`

**Mejoras implementadas**:

1. **Sistema de Reintentos Autom√°ticos**
   - 3 reintentos por defecto
   - 1 segundo entre reintentos
   - Reintentos reducidos para subida de fotos

2. **Timeouts Aumentados**
   - Health check: 10 segundos
   - Operaciones normales: 20 segundos
   - Subida de fotos: 30 segundos

3. **Manejo de Errores Inteligente**
   - Detecta errores de red
   - Detecta timeouts
   - Detecta errores del servidor
   - Mensajes descriptivos para el usuario

4. **Logging Detallado**
   - Todas las operaciones se registran en consola
   - Errores con contexto completo
   - Ayuda en debugging

**Beneficio**: Mejor experiencia de usuario y m√°s f√°cil debugging

---

## Pasos para Deployment

### 1. Backend (Render.com)

1. **Actualizar c√≥digo en Render**:
   - Push de cambios a GitHub
   - Render detecta y despliega autom√°ticamente

2. **Verificar variables de entorno**:
   ```
   SPREADSHEET_ID=tu_spreadsheet_id_aqui
   GOOGLE_CREDENTIALS={...json...}
   PORT=3000
   ```

3. **Verificar deployment**:
   - Visitar: `https://qr-manager-backend-l6dg.onrender.com/`
   - Debe mostrar: "QR Manager Backend v2.1"

### 2. Apps M√≥viles

#### ResidenteApp

```bash
cd apps/ResidenteApp

# Limpiar build anterior
cd android && ./gradlew clean && cd ..

# Build de release
cd android && ./gradlew assembleRelease && cd ..

# APK generado en:
# android/app/build/outputs/apk/release/app-universal-release.apk
```

#### VigilanciaApp

```bash
cd apps/VigilanciaApp

# Limpiar build anterior
cd android && ./gradlew clean && cd ..

# Build de release
cd android && ./gradlew assembleRelease && cd ..

# APK generado en:
# android/app/build/outputs/apk/release/app-universal-release.apk
```

---

## Testing Recomendado

### Backend

1. **Health Check**:
   ```bash
   curl https://qr-manager-backend-l6dg.onrender.com/health
   ```

2. **Registrar c√≥digo**:
   ```bash
   curl -X POST https://qr-manager-backend-l6dg.onrender.com/api/register-code \
     -H "Content-Type: application/json" \
     -d '{"houseNumber": 25, "condominio": "Unica"}'
   ```

3. **Verificar logs en Render**:
   - Buscar emojis: üìù, ‚úÖ, ‚ùå
   - Verificar que no hay errors

### Apps M√≥viles

1. **ResidenteApp**:
   - ‚úÖ Login funciona
   - ‚úÖ Generar c√≥digo QR funciona
   - ‚úÖ Compartir funciona
   - ‚úÖ Historial se carga
   - ‚úÖ No hay flashazo blanco

2. **VigilanciaApp**:
   - ‚úÖ Dashboard se carga
   - ‚úÖ Contadores se muestran
   - ‚úÖ Validar c√≥digo funciona
   - ‚úÖ Registrar trabajador funciona
   - ‚úÖ No hay flashazo blanco

---

## Notas Importantes

1. **SPREADSHEET_ID es CR√çTICO**:
   - Sin esta variable, el backend no funciona
   - Debe estar configurada en Render.com

2. **ProGuard est√° ACTIVO en Release**:
   - Las reglas est√°n configuradas
   - No modificar sin probar

3. **Reintentos Autom√°ticos**:
   - Las apps intentan 3 veces antes de fallar
   - Render puede tardar en despertar (modo free)

4. **Logging Habilitado**:
   - Todas las operaciones se registran
   - Facilita debugging en producci√≥n

---

## Archivos Modificados

### Backend
- ‚úÖ `backend/src/services/sheetsService.js` - Manejo de errores completo
- ‚úÖ `backend/src/utils/paramMapper.js` - NUEVO m√≥dulo de mapeo
- ‚úÖ `backend/src/server.js` - Endpoints adaptados
- ‚úÖ `backend/.env.example` - Documentaci√≥n completa

### Apps M√≥viles
- ‚úÖ `apps/ResidenteApp/src/services/api.ts` - Reintentos + errores
- ‚úÖ `apps/VigilanciaApp/src/services/api.ts` - Reintentos + errores
- ‚úÖ `apps/ResidenteApp/android/app/proguard-rules.pro` - Reglas completas
- ‚úÖ `apps/VigilanciaApp/android/app/proguard-rules.pro` - Reglas completas

---

## Versiones

- **Backend**: 2.1.0
- **ResidenteApp**: 1.1
- **VigilanciaApp**: 1.1

---

## Pr√≥ximos Pasos Recomendados

1. ‚úÖ Hacer backup del spreadsheet actual
2. ‚úÖ Desplegar backend en Render
3. ‚úÖ Probar endpoint health
4. ‚úÖ Generar APKs de release
5. ‚úÖ Probar en dispositivos reales
6. ‚úÖ Monitorear logs en producci√≥n

---

**IMPORTANTE**: Antes de desplegar, aseg√∫rate de que SPREADSHEET_ID est√© configurado en las variables de entorno de Render.com
